---
title: "Homework 6"
format: html
---
```{r}
library(deSolve)
library(ggplot2)

############################################################
# FUNCTION: run_sir_model
# PURPOSE: Solve deterministic SIR model with deSolve
# INPUTS:
#   beta, gamma : transmission & recovery rates
#   N           : total population
#   S0, I0, R0  : initial conditions
#   t_start     : start time
#   t_end       : end time
#   dt          : timestep
# OUTPUT:
#   data.frame with columns: time, S, I, R
############################################################

run_sir_model <- function(
  beta    = 0.1,
  gamma   = 0.1,
  N       = 1000,
  S0      = 999,
  I0      = 1,
  R0      = 0,
  t_start = 0,
  t_end   = 160,
  dt      = 1
) {

  init  <- c(S = S0, I = I0, R = R0)
  times <- seq(t_start, t_end, by = dt)

  sir_equations <- function(time, state, parameters) {
    with(as.list(c(state, parameters)), {
      dS <- -beta * S * I / N
      dI <-  beta * S * I / N - gamma * I
      dR <-  gamma * I
      list(c(dS, dI, dR))
    })
  }

  out <- ode(
    y     = init,
    times = times,
    func  = sir_equations,
    parms = c(beta = beta, gamma = gamma, N = N)
  )

  as.data.frame(out)
}

# PURPOSE: Create a data frame with max infected, beta, and gamma with vectors of β and γ values ranging from 0 to 0.5 in steps of 0.01.
# INPUTS:
#   beta, gamma : transmission & recovery rates
#   N           : total population
#   S0, I0, R0  : initial conditions
#   t_start     : start time
#   t_end       : end time
#   dt          : timestep
# OUTPUT: df with columns, max_infected, beta, gamma

sir_para_sweep <- function(beta_vec, gamma_vec) {
  n_combos <- length(beta_vec) * length(gamma_vec)
  sir_result <- data.frame(
    max_infected = numeric(n_combos),
    beta = numeric(n_combos),
    gamma = numeric(n_combos)
  )
  
  counter <- 1
  for (b in beta_vec) {
    for (g in gamma_vec) {
      
      # uses previous and changes only beta and gamma 
      sir_out <- run_sir_model(beta = b, gamma = g)
      
      sir_result$max_infected[counter] <- max(sir_out$I)
      sir_result$beta[counter] <- b
      sir_result$gamma[counter] <- g
      counter <- counter + 1
    }
  }
    return(sir_result)
}


# FUNCTION: plot_sir_heatmap_ggplot
# PURPOSE: Create a heatmap of max(number of infected) with Transmission Rate, β and Recovery Rate,γ as your x and y axises
# INPUT: sweep_df : data frame with columns beta, gamma, max_infected
# OUTPUT: Heatmap

plot_sir_heatmap_ggplot <- function(sweep_df) {

  p <- ggplot(sweep_df, aes(x = beta, y = gamma, fill = max_infected)) +
    geom_tile() +
    scale_fill_gradient(
      low = "blue", 
      high = "red", 
      name = "Max Infected"
    ) +
    labs(
      x = expression("Transmission Rate (" * beta * ")"),
      y = expression("Recovery Rate (" * gamma * ")"),
      title = "SIR Model Parameter Sweep"
    ) +
    theme_minimal() +
    theme(plot.title = element_text(size = 20))
  
  return(p)
}

beta_vec  <- seq(0, 0.5, by = 0.01)
gamma_vec <- seq(0, 0.5, by = 0.01)
sweep_results <- sir_para_sweep(beta_vec, gamma_vec)
plot_sir_heatmap_ggplot(sweep_results)

```


